// Aggiungi questa variabile globale per il cambio dinamico
async function updateFxRate() {
    try {
        const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=FX:EURUSD&token=${API_KEY}`).then(r => r.json());
        if(res.c) fxRate = 1 / res.c; // Invertiamo per avere USD -> EUR
    } catch(e) { console.warn("Cambio FX: Errore, uso fallback 0.85"); }
}

async function doSearch() {
    const q = document.getElementById('sInput').value.trim().toUpperCase();
    if(!q) return;
    const list = document.getElementById('results-list');
    list.innerHTML = "<div style='padding:20px'>üîç Analisi di mercato in corso...</div>";
    
    try {
        const res = await fetch(`https://finnhub.io/api/v1/search?q=${q}&token=${API_KEY}`).then(r => r.json());
        list.innerHTML = "";
        
        if(!res.result || res.result.length === 0) {
            list.innerHTML = "Nessun titolo trovato.";
            return;
        }

        for(let item of res.result.slice(0, 5)) {
            let sym = item.symbol;
            // Correzione automatica per titoli italiani comuni
            if(!sym.includes('.') && (item.description.includes("SPA") || item.displaySymbol.includes(".MI"))) {
                sym += ".MI";
            }
            
            const qte = await fetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${API_KEY}`).then(r => r.json());
            const isFav = favs.includes(sym);
            
            // Logica prezzo: se √® .MI √® gi√† in Euro, altrimenti convertiamo
            let isItalian = sym.endsWith('.MI');
            let rawPrice = qte.c || 0;
            let priceEur = isItalian ? rawPrice : (rawPrice * fxRate);
            
            if(priceEur === 0) continue; // Salta risultati senza dati

            let color = qte.dp >= 0 ? 'var(--up)' : 'var(--down)';
            let sign = qte.dp >= 0 ? '+' : '';

            list.innerHTML += `
                <div class="res-item">
                    <button class="fav-btn ${isFav?'active':''}" onclick="event.stopPropagation(); toggleFavorite('${sym}')">‚òÖ</button>
                    <div onclick="openChart('${sym}')">
                        <small>${item.type || 'Azione'}</small><br>
                        <strong>${sym}</strong> - ${item.description}<br>
                        <span style="color:${color}; font-size:1.6rem; font-weight:900;">${priceEur.toLocaleString('it-IT', {style:'currency', currency:'EUR'})}</span>
                        <span style="color:${color}; font-size:0.9rem; margin-left:10px;">${sign}${qte.dp?.toFixed(2)}%</span>
                    </div>
                </div>`;
        }
    } catch(e) { list.innerHTML = "Errore di connessione. Riprova."; }
}

function openChart(s) {
    document.getElementById('side-favs').classList.remove('open');
    const container = document.getElementById('chart-container');
    container.style.display = "block";
    
    // Pulizia container per evitare bug di rendering
    document.getElementById('tv-widget').innerHTML = ""; 

    // Mapping ticker per TradingView
    let tvSymbol = s.includes(".MI") ? `MIL:${s.split('.')[0]}` : s;
    
    new TradingView.widget({
      "autosize": true,
      "symbol": tvSymbol,
      "interval": "D",
      "timezone": "Europe/Rome",
      "theme": "dark",
      "style": "1",
      "locale": "it",
      "toolbar_bg": "#f1f3f6",
      "enable_publishing": false,
      "allow_symbol_change": true,
      "container_id": "tv-widget"
    });
    
    window.scrollTo({ top: container.offsetTop - 20, behavior: 'smooth' });
}
