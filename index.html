<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Borsa Carli Pro - Yahoo Direct €</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #34d399; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --up: #10b981; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; }
    header { background: #1e293b; padding: 15px; text-align: center; border-bottom: 3px solid var(--primary); }
    main { padding: 15px; max-width: 1200px; margin: auto; display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; }
    @media (max-width: 850px) { main { grid-template-columns: 1fr; } }
    
    .box { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid #334155; }
    .m-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .m-card { background: #0f172a; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid var(--primary); }
    .price-big { font-size: 1.4rem; font-weight: 800; color: var(--up); display: block; margin-top: 5px; }
    
    .unit-btn { background: #334155; border: none; color: #94a3b8; padding: 8px 15px; border-radius: 8px; cursor: pointer; margin-bottom: 15px; font-weight: 600; }
    .unit-btn.active { background: var(--primary); color: #064e3b; }

    .news-card { padding: 10px 0; border-bottom: 1px solid #334155; font-size: 0.85rem; }
    .news-card a { color: #cbd5e1; text-decoration: none; }
    .search-box { display: flex; gap: 8px; margin-bottom: 20px; }
    input { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #334155; background: #0f172a; color: white; }
    .btn-p { background: var(--primary); color: #064e3b; border: none; padding: 0 20px; border-radius: 10px; font-weight: 800; cursor: pointer; }
  </style>
</head>
<body>

<header><h1>BORSA <span style="color:var(--primary)">CARLI</span> PRO</h1></header>

<main>
  <div class="box">
    <h3 style="color:var(--primary); margin-top:0;">NEWS MERCATO</h3>
    <div id="news-list">Caricamento...</div>
  </div>

  <div>
    <div style="text-align:center;">
        <button class="unit-btn active" id="btn-oz" onclick="updateView('oz')">Oncia</button>
        <button class="unit-btn" id="btn-50g" onclick="updateView('50g')">50 Grammi</button>
        <button class="unit-btn" id="btn-100g" onclick="updateView('100g')">100 Grammi</button>
    </div>

    <div class="m-grid">
      <div class="m-card"><strong>ORO (€)</strong><span id="gold-p" class="price-big">---</span></div>
      <div class="m-card"><strong>ARGENTO (€)</strong><span id="silver-p" class="price-big">---</span></div>
    </div>

    <div class="search-box">
      <input type="text" id="sInput" placeholder="Cerca Azione (RACE, ENI.MI...)">
      <button class="btn-p" onclick="doSearch()">CERCA</button>
    </div>
    <div id="res-box"></div>
  </div>
</main>

<script>
  const API_KEY = "d6b3blpr01qnr27jgq90d6b3blpr01qnr27jgq9g";
  let currentPrices = { gold: 0, silver: 0 };
  let currentMode = 'oz';

  async function getYahooPrice(ticker) {
    try {
      // Usiamo Yahoo direttamente per i ticker in Euro
      const r = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}`).then(res => res.json());
      return r.chart.result[0].meta.regularMarketPrice;
    } catch(e) { return null; }
  }

  async function loadData() {
    // Prendiamo l'oro e l'argento DIRETTAMENTE IN EURO da Yahoo
    currentPrices.gold = await getYahooPrice('XAUER=X') || 2650; 
    currentPrices.silver = await getYahooPrice('XAGER=X') || 30;
    
    updateView(currentMode);
    loadNews();
  }

  function updateView(mode) {
    currentMode = mode;
    document.querySelectorAll('.unit-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`btn-${mode}`).classList.add('active');

    const ozToGram = 31.1035;
    let gPrice = mode === 'oz' ? currentPrices.gold : 
                mode === '50g' ? (currentPrices.gold / ozToGram) * 50 : 
                (currentPrices.gold / ozToGram) * 100;

    let sPrice = mode === 'oz' ? currentPrices.silver : 
                mode === '50g' ? (currentPrices.silver / ozToGram) * 50 : 
                (currentPrices.silver / ozToGram) * 100;

    document.getElementById('gold-p').innerText = gPrice.toLocaleString('it-IT', {style:'currency', currency:'EUR'});
    document.getElementById('silver-p').innerText = sPrice.toLocaleString('it-IT', {style:'currency', currency:'EUR'});
  }

  async function loadNews() {
    const res = await fetch(`https://finnhub.io/api/v1/news?category=general&token=${API_KEY}`).then(r => r.json());
    document.getElementById('news-list').innerHTML = res.slice(0, 7).map(n => `
      <div class="news-card"><a href="${n.url}" target="_blank">• ${n.headline.substring(0,60)}...</a></div>
    `).join('');
  }

  async function doSearch() {
    const q = document.getElementById('sInput').value.toUpperCase();
    const r = await fetch(`https://finnhub.io/api/v1/quote?symbol=${q}&token=${API_KEY}`).then(res => res.json());
    if(r.c) {
        document.getElementById('res-box').innerHTML = `
          <div class="m-card" style="margin-top:10px;">
            <strong>${q}</strong><br><span class="price-big">${r.c.toFixed(2)} €</span>
          </div>`;
    }
  }

  loadData();
</script>
</body>
</html>
