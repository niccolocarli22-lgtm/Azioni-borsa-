<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StockVision Ultra - Pro Trader</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #3b82f6; --bg: #0f172a; --card-bg: #1e293b; --text: #f8fafc; --border: #334155; }
    * { box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
    header { background: #020617; padding: 40px 20px; text-align: center; border-bottom: 2px solid var(--primary); }
    main { padding: 20px; max-width: 1400px; margin: auto; }
    
    .search-bar { display: flex; gap: 10px; background: var(--card-bg); padding: 15px; border-radius: 15px; margin-top: -30px; border: 1px solid var(--border); }
    input { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: #0f172a; color: white; outline: none; }
    button { padding: 10px 25px; border-radius: 8px; border: none; background: var(--primary); color: white; cursor: pointer; font-weight: 600; }

    .section-title { margin: 30px 0 15px; font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
    
    /* Grid per Metalli e Watchlist */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 15px; }
    .card { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border); transition: 0.3s; cursor: pointer; }
    .card:hover { transform: translateY(-3px); border-color: var(--primary); }
    
    .price-up { color: #22c55e; font-weight: 600; }
    .price-down { color: #ef4444; font-weight: 600; }

    /* Risultati di ricerca migliorati */
    #results-list { display: grid; gap: 10px; margin: 20px 0; }
    .search-res { background: var(--card-bg); padding: 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
    
    /* Grafico Gigante */
    #chart-box { margin-top: 30px; background: var(--card-bg); padding: 10px; border-radius: 20px; display: none; border: 1px solid var(--border); }
    #tradingview_widget { height: 800px; width: 100%; }

    .unit-badge { font-size: 0.7rem; background: #334155; padding: 2px 6px; border-radius: 4px; vertical-align: middle; }
  </style>
</head>
<body>

<header>
  <h1>StockVision <span style="color:var(--primary)">Ultra</span></h1>
  <p>Metalli, Azioni e Analisi Professionale</p>
</header>

<main>
  <div class="search-bar">
    <input type="text" id="sInput" placeholder="Cerca Azioni, Crypto o Indici..." onkeypress="if(event.key==='Enter') doSearch()">
    <button onclick="doSearch()">Analizza</button>
  </div>

  <h2 class="section-title">⚖️ Materie Prime & Metalli</h2>
  <div class="grid" id="metals-grid">
    <div class="card" onclick="openChart('TVC:GOLD')">
      <strong>Oro (Gold)</strong><br>
      <div id="gold-price" class="price-up">Caricamento...</div>
      <small id="gold-units" style="color:var(--primary)"></small>
    </div>
    <div class="card" onclick="openChart('TVC:SILVER')">
      <strong>Argento</strong><br>
      <div id="silver-price" class="price-up">Caricamento...</div>
      <small id="silver-units" style="color:var(--primary)"></small>
    </div>
    <div class="card" onclick="openChart('CAPITALCOM:ALUMINIUM')">
      <strong>Alluminio</strong><br>
      <div id="alu-price">Caricamento...</div>
      <small>Prezzo per Tonnellata (USD)</small>
    </div>
  </div>

  <div id="fav-container" style="display:none">
    <h2 class="section-title">⭐ I Tuoi Preferiti (Watchlist)</h2>
    <div class="grid" id="fav-grid"></div>
  </div>

  <div id="results-list"></div>

  <div id="chart-box">
    <div id="tradingview_widget"></div>
  </div>
</main>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
  const key = "d6b3blpr01qnr27jgq90d6b3blpr01qnr27jgq9g";
  let favs = JSON.parse(localStorage.getItem('ultraFavs')) || [];

  // 1. CARICAMENTO METALLI E CAMBI
  async function loadMetals() {
    const gold = await fetch(`https://finnhub.io/api/v1/quote?symbol=GC=F&token=${key}`).then(r => r.json());
    const silver = await fetch(`https://finnhub.io/api/v1/quote?symbol=SI=F&token=${key}`).then(r => r.json());
    const alu = await fetch(`https://finnhub.io/api/v1/quote?symbol=ALU&token=${key}`).then(r => r.json());
    
    if(gold.c) {
      document.getElementById('gold-price').innerHTML = `$${gold.c} <small>(${gold.dp.toFixed(2)}%)</small>`;
      const perGram = (gold.c / 31.1035).toFixed(2);
      document.getElementById('gold-units').innerHTML = `1g: $${perGram} | 50g: $${(perGram*50).toFixed(0)} | 100g: $${(perGram*100).toFixed(0)}`;
    }
    if(silver.c) {
      document.getElementById('silver-price').innerHTML = `$${silver.c} <small>(${silver.dp.toFixed(2)}%)</small>`;
      document.getElementById('silver-units').innerHTML = `1g: $${(silver.c/31.1).toFixed(2)}`;
    }
    renderFavs();
  }

  // 2. RICERCA CON PREZZI LIVE
  async function doSearch() {
    const q = document.getElementById('sInput').value;
    const list = document.getElementById('results-list');
    list.innerHTML = "Ricerca in corso...";
    
    const res = await fetch(`https://finnhub.io/api/v1/search?q=${q}&token=${key}`).then(r => r.json());
    list.innerHTML = "";
    
    for(let item of res.result.slice(0, 5)) {
      const quote = await fetch(`https://finnhub.io/api/v1/quote?symbol=${item.symbol}&token=${key}`).then(r => r.json());
      const div = document.createElement('div');
      div.className = "search-res";
      const color = quote.dp >= 0 ? 'price-up' : 'price-down';
      const priceHtml = quote.c ? `<span class="${color}">$${quote.c} (${quote.dp.toFixed(2)}%)</span>` : '';
      
      div.innerHTML = `
        <div onclick="openChart('${item.symbol}')" style="cursor:pointer">
          <strong>${item.symbol}</strong> - ${item.description.substring(0,30)}<br>${priceHtml}
        </div>
        <button onclick="toggleFav('${item.symbol}')" style="background:none; font-size:1.5rem">${favs.includes(item.symbol)?'⭐':'☆'}</button>
      `;
      list.appendChild(div);
    }
  }

  // 3. GESTIONE PREFERITI
  function toggleFav(s) {
    if(favs.includes(s)) favs = favs.filter(x => x !== s);
    else favs.push(s);
    localStorage.setItem('ultraFavs', JSON.stringify(favs));
    renderFavs();
    doSearch();
  }

  function renderFavs() {
    const cont = document.getElementById('fav-container');
    const grid = document.getElementById('fav-grid');
    if(favs.length === 0) { cont.style.display = "none"; return; }
    cont.style.display = "block";
    grid.innerHTML = favs.map(s => `
      <div class="card" onclick="openChart('${s}')">
        <strong>${s}</strong>
        <p>Analisi Rapida</p>
      </div>
    `).join('');
  }

  // 4. GRAFICO CON FIX PER SIMBOLI LOCALI
  function openChart(s) {
    document.getElementById('chart-box').style.display = "block";
    // Fix per simboli locali (es. aziende italiane o exchange specifici)
    let cleanSymbol = s;
    if(s.includes(':')) cleanSymbol = s; 
    
    new TradingView.widget({
      "autosize": true,
      "symbol": cleanSymbol,
      "interval": "D",
      "timezone": "Etc/UTC",
      "theme": "dark",
      "style": "1",
      "locale": "it",
      "container_id": "tradingview_widget",
      "allow_symbol_change": true,
      "details": true,
      "hotlist": true
    });
    window.scrollTo({ top: document.getElementById('chart-box').offsetTop, behavior: 'smooth' });
  }

  loadMetals();
</script>
</body>
</html>
