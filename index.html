<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Borsa Carli - V1 Stabile</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#020617">
  <script>if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }</script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #3b82f6; --bg: #020617; --card: #111827; --text: #f3f4f6; --up: #22c55e; --down: #ef4444; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow-x: hidden; }
    
    /* SCHERMATA DI BLOCCO TOTALE */
    #lock-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--bg); z-index: 10000;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      text-align: center;
    }
    .pin-input {
      font-size: 2rem; padding: 15px; text-align: center; width: 220px;
      background: var(--card); border: 2px solid var(--primary); color: white; border-radius: 12px;
      letter-spacing: 5px; outline: none; margin-top: 20px;
    }

    /* NASCONDI TUTTO IL CONTENUTO ALL'INIZIO */
    #main-content { display: none; }

    header { background: #0f172a; padding: 25px; text-align: center; border-bottom: 5px solid var(--primary); position: relative; }
    .fav-toggle { position: absolute; right: 25px; top: 25px; font-size: 2.5rem; cursor: pointer; background: none; border: none; color: #f59e0b; z-index: 100; }
    main { padding: 20px; max-width: 1400px; margin: auto; }
    #side-favs { position: fixed; right: 0; top: 0; width: 350px; height: 100%; background: #0f172a; border-left: 4px solid var(--primary); z-index: 9999; transform: translateX(105%); transition: transform 0.4s; padding: 25px; overflow-y: auto; }
    #side-favs.open { transform: translateX(0); }
    .search-box { display: flex; gap: 10px; margin-bottom: 30px; margin-top: -20px; }
    input { flex: 1; padding: 15px; border-radius: 10px; border: 1px solid #374151; background: var(--card); color: white; }
    .btn-p { background: var(--primary); color: white; border: none; padding: 15px 30px; border-radius: 10px; cursor: pointer; font-weight: 900; }
    .unit-controls { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; }
    .unit-btn { background: #374151; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
    .unit-btn.active { background: var(--primary); }
    .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }
    .box { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid #374151; }
    .m-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
    .m-card { background: #1f2937; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #4b5563; }
    .price-big { font-size: 1.8rem; font-weight: 900; color: var(--up); display: block; }
    #chart-container { margin-top: 30px; height: 600px; border-radius: 15px; border: 2px solid #374151; display: none; }
  </style>
</head>
<body>

<div id="lock-screen">
  <h2 style="color:var(--primary); font-size: 2rem;">BORSA CARLI</h2>
  <p>Software Protetto - Inserisci PIN</p>
  <input type="password" id="pinCode" class="pin-input" maxlength="6" placeholder="******">
  <button class="btn-p" style="margin-top:20px" onclick="checkPin()">ACCEDI</button>
  <p id="pinError" style="color:var(--down); margin-top:15px; display:none; font-weight:bold;">PIN ERRATO!</p>
</div>

<div id="main-content">
  <header>
    <button class="fav-toggle" onclick="toggleFavs()">‚≠ê</button>
    <h1>Borsa <span style="color:var(--primary)">Carli</span></h1>
  </header>

  <main>
    <div class="search-box">
      <input type="text" id="sInput" placeholder="Cerca: Danieli, Ferrari, Oro...">
      <button class="btn-p" onclick="doSearch()">CERCA</button>
    </div>

    <div class="main-grid">
      <div class="box">
        <h2 style="color:var(--primary)">üáÆüáπ Notizie Italia</h2>
        <div id="news-list">Caricamento...</div>
      </div>
      <div>
        <div class="unit-controls">
          <button class="unit-btn active" onclick="setUnit('oz', this)">Oncia</button>
          <button class="unit-btn" onclick="setUnit('1g', this)">1g</button>
        </div>
        <div class="m-grid" id="metals-display">
          <div class="m-card">Caricamento Oro...</div>
          <div class="m-card">Caricamento Argento...</div>
        </div>
      </div>
    </div>
    <div id="chart-container"><div id="tv-widget" style="height:100%"></div></div>
  </main>
</div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
  const API_KEY = "d6b3blpr01qnr27jgq90d6b3blpr01qnr27jgq9g";
  let fxRate = 0.92;
  let rawMetals = { gold: 0, silver: 0 };
  let currentUnit = 'oz';

  function checkPin() {
    const pin = document.getElementById('pinCode').value;
    if (pin === "220811") {
      unlockApp();
    } else {
      document.getElementById('pinError').style.display = 'block';
      document.getElementById('pinCode').value = "";
    }
  }

  function unlockApp() {
    document.getElementById('lock-screen').style.display = 'none';
    document.getElementById('main-content').style.display = 'block';
    sessionStorage.setItem('accessGranted', 'true');
    loadAllData();
  }

  if (sessionStorage.getItem('accessGranted') === 'true') {
    unlockApp();
  }

  async function loadAllData() {
    await updateExchangeRate();
    loadMetals();
    loadNews();
  }

  async function updateExchangeRate() {
    try {
      const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=FX:EURUSD&token=${API_KEY}`).then(r => r.json());
      if(res.c) fxRate = 1 / res.c;
    } catch(e) {}
  }

  async function loadMetals() {
    try {
      const g = await fetch(`https://finnhub.io/api/v1/quote?symbol=OANDA:XAU_USD&token=${API_KEY}`).then(r => r.json());
      const s = await fetch(`https://finnhub.io/api/v1/quote?symbol=OANDA:XAG_USD&token=${API_KEY}`).then(r => r.json());
      
      if(g.c && g.c > 0) {
        rawMetals.gold = g.c;
        rawMetals.silver = s.c;
        updateMetalDisplay();
      } else {
        // Se il prezzo √® ancora 0, riprova tra 2 secondi
        setTimeout(loadMetals, 2000);
      }
    } catch(e) { setTimeout(loadMetals, 2000); }
  }

  function updateMetalDisplay() {
    const factors = { 'oz': 1, '1g': 1/31.1035 };
    const conv = (p) => (p * factors[currentUnit] * fxRate).toLocaleString('it-IT', {style:'currency', currency:'EUR'});
    document.getElementById('metals-display').innerHTML = `
      <div class="m-card"><strong>ORO (${currentUnit})</strong><span class="price-big">${conv(rawMetals.gold)}</span></div>
      <div class="m-card"><strong>ARGENTO (${currentUnit})</strong><span class="price-big">${conv(rawMetals.silver)}</span></div>
    `;
  }

  function setUnit(u, btn) {
    currentUnit = u;
    document.querySelectorAll('.unit-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    updateMetalDisplay();
  }

  async function loadNews() {
    try {
      const res = await fetch(`https://finnhub.io/api/v1/news?category=general&token=${API_KEY}`).then(r => r.json());
      document.getElementById('news-list').innerHTML = res.slice(0, 5).map(n => `
        <div style="margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:5px;">
          <a href="${n.url}" target="_blank" style="color:white; text-decoration:none; font-weight:bold;">${n.headline}</a>
        </div>`).join('');
    } catch(e) {}
  }

  function openChart(s) {
    document.getElementById('chart-container').style.display = "block";
    new TradingView.widget({
      "autosize": true, "symbol": s, "interval": "D", "theme": "dark", "style": "2",
      "container_id": "tv-widget", "hide_side_toolbar": true, "range": "1M"
    });
  }
</script>
</body>
</html>
